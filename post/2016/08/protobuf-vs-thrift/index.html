<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="generator" content="Hugo 0.16" />
    <link rel="shortcut icon" href="/images/favicon.ico">
    
    <link href="/index.xml" rel="alternate" type="application/rss+xml" title="babifarm.com" />
    <link href="/index.xml" rel="feed" type="application/rss+xml" title="babifarm.com" />
    
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    
    <script src="https://apis.google.com/js/platform.js" async defer>{lang: 'ja'}</script>
    
    <link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">
    <script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <title>Protobuf vs Thrift 性能测试 | babifarm.com</title>
  </head>
  <body>    
    <div id="wrap">
      
      <header class="site-header">
        <div class="site-header-left">
          <a class="site-header-title" href="http://babifarm.com/">babifarm.com</a>
        </div>
      </header>
      <div class="container">
        <div id="main">

<div class="article">
  <header>
    <div class="article-header">
      <h1>Protobuf vs Thrift 性能测试</h1>
      <div class="article-meta">
        <span class="posttime">2016/08/02</span>
        
<div class="tags">
  <ul>
    
    <li>
      <a href="/tags/protobuf"><span></span>protobuf</a>
    </li>
    
    <li>
      <a href="/tags/thrift"><span></span>Thrift</a>
    </li>
    
  </ul>
</div>


      </div>
    </div>
    
<div id="share-buttons">
  <ul>
    
    
    
    
    
  </ul>
</div>


  </header>
  <div class="content">
    

<h2 id="简单对象结构的对比">简单对象结构的对比</h2>

<h3 id="protobuf-文件">protobuf 文件</h3>

<pre><code class="language-xml">package com.many.pro;
message User
{
    required string id = 1;
    required int32  weight = 2;
    required int32 age = 3;
    required string name = 4;
    required string title = 5;
    required string desc = 6;
}

</code></pre>

<h3 id="thrift-文件">thrift  文件</h3>

<pre><code class="language-xml">namespace java com.many.thrift
struct User{

        1: required string id ;
        2: required i32  weight  ;
        3: required i32 age  ;
        4: required string name  ;
        5: required string title ;
        6: required string desc ;

}
</code></pre>

<h3 id="测试前提">测试前提：</h3>

<p>测试对象：测试时都会设置相同的属性值，保证测试公平</p>

<h3 id="测试结果">测试结果：</h3>

<p>1、固定1分钟测试结果</p>

<table>
<thead>
<tr>
<th>名称</th>
<th>动作</th>
<th>大小</th>
<th>次数</th>
</tr>
</thead>

<tbody>
<tr>
<td>protobuf</td>
<td>序列化</td>
<td>965 byte</td>
<td>12,560,420</td>
</tr>

<tr>
<td>thrift</td>
<td>序列化</td>
<td>994 byte</td>
<td>8,487,338</td>
</tr>

<tr>
<td>protobuf</td>
<td>反序列化</td>
<td>965 byte</td>
<td>88,119,395</td>
</tr>

<tr>
<td>thrift</td>
<td>反序列化</td>
<td>994 byte</td>
<td>10,147,918</td>
</tr>

<tr>
<td>protobuf</td>
<td>序列化反序列化交替进行</td>
<td>965 byte</td>
<td>10,713,643*2</td>
</tr>

<tr>
<td>thrift</td>
<td>序列化反序列化交替进行</td>
<td>994 byte</td>
<td>4,495,906*2</td>
</tr>
</tbody>
</table>

<p>2、固定次数（1000000次）测试结果：</p>

<table>
<thead>
<tr>
<th>名称</th>
<th>动作</th>
<th>大小</th>
<th>时间(ms)</th>
</tr>
</thead>

<tbody>
<tr>
<td>protobuf</td>
<td>序列化</td>
<td>965 byte</td>
<td>4782</td>
</tr>

<tr>
<td>thrift</td>
<td>序列化</td>
<td>994 byte</td>
<td>6965</td>
</tr>

<tr>
<td>protobuf</td>
<td>反序列化</td>
<td>965 byte</td>
<td>624</td>
</tr>

<tr>
<td>thrift</td>
<td>反序列化</td>
<td>994 byte</td>
<td>5662</td>
</tr>
</tbody>
</table>

<h3 id="测试代码">测试代码</h3>

<p>1、protobuf 固定100000此测试代码（简单对象）</p>

<pre><code class="language-java">package com.many.pro.thriftvsproto;

import com.google.protobuf.InvalidProtocolBufferException;
import com.many.pro.UserModel;


public class ProtoSimpleTest {
    private byte [] bytes;
    public void serialization(){
        long start = System.currentTimeMillis();
        for(int i=0;i&lt;1000000;i++){
            UserModel.User.Builder builder = UserModel.User.newBuilder();
            builder.setId(&quot;123&quot;);
            builder.setAge(123);
            builder.setDesc(&quot;ni hao i am test&quot;);
            builder.setName(&quot;test&quot;);
            builder.setTitle(&quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                    &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                    &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                    &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                    &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                    &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                    &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                    &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot;);
            builder.setWeight(200);
            UserModel.User  user = builder.build();
            user.toByteArray();
        }
        long lastTime = System.currentTimeMillis() - start;
        initBytes();
        int size = bytes.length;
        System.out.println(&quot;protobuffer 序列化循环100w times，单条大小：&quot;+size+&quot; byte&quot;+&quot; 耗时：&quot;+lastTime+&quot; ms&quot;);
    }

    public void un_serialization(){
        initBytes();
        long start = System.currentTimeMillis();
        try {
            for(int i=0;i&lt;1000000;i++){

                    UserModel.User  user =  UserModel.User.parseFrom(bytes);

            }
        } catch (InvalidProtocolBufferException e) {
            e.printStackTrace();
        }

        int size = bytes.length;
        long lastTime = System.currentTimeMillis() - start;
        System.out.println(&quot;protobuffer 反序列化循环100w times，单条大小：&quot;+size+&quot; byte&quot;+&quot; 耗时：&quot;+lastTime+&quot; ms&quot;);
    }

    public void initBytes(){
        UserModel.User.Builder builder = UserModel.User.newBuilder();
        builder.setId(&quot;123&quot;);
        builder.setAge(123);
        builder.setDesc(&quot;ni hao i am test&quot;);
        builder.setName(&quot;test&quot;);
        builder.setTitle(&quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot;);
        builder.setWeight(200);
        UserModel.User  user = builder.build();
        bytes = user.toByteArray();

    }


    public static void main(String [] args){
        ProtoSimpleTest test = new ProtoSimpleTest();
        test.serialization();
        test.un_serialization();

    }
}

</code></pre>

<p>2、thrift 固定100000此测试代码（简单对象）</p>

<pre><code class="language-java">package com.many.pro.thriftvsproto;


import org.apache.thrift.TException;
import org.apache.thrift.protocol.TBinaryProtocol;
import org.apache.thrift.transport.TIOStreamTransport;
import org.apache.thrift.transport.TTransport;
import com.many.thrift.User;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;


public class ThriftSimlpleTest {
    private byte [] bytes;
    public void serialization() throws TException {
        long start = System.currentTimeMillis();
        for(int i=0;i&lt;1000000;i++){
            User user  = new User();
            user.setId(&quot;123&quot;);
            user.setAge(123);
            user.setDesc(&quot;ni hao i am test&quot;);
            user.setName(&quot;test&quot;);
            user.setTitle(&quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                    &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                    &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                    &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                    &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                    &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                    &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                    &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot;);
            user.setWeight(200);
            // 序列化
            ByteArrayOutputStream out = new ByteArrayOutputStream();
            TTransport trans = new TIOStreamTransport(out);
            TBinaryProtocol tp = new TBinaryProtocol(trans);
            user.write(tp);
            //out.toByteArray();
        }
        long lastTime = System.currentTimeMillis() - start;
        initBytes();
        int size = bytes.length;
        System.out.println(&quot;Thrift 序列化循环100w times，单条大小：&quot;+size+&quot; byte&quot;+&quot; 耗时：&quot;+lastTime+&quot; ms&quot;);
    }
    public void un_serialization() throws TException {
        initBytes();
        long start = System.currentTimeMillis();
        for(int i=0;i&lt;1000000;i++){

            // 反序列化
            ByteArrayInputStream in = new ByteArrayInputStream(bytes);
            TTransport trans = new TIOStreamTransport(in);
            TBinaryProtocol tp  = new TBinaryProtocol(trans);
            User user  = new User();
            user.read(tp);
        }

        int size = bytes.length;
        long lastTime = System.currentTimeMillis() - start;
        System.out.println(&quot;Thrift 反序列化循环100w times，单条大小：&quot;+size+&quot; byte&quot;+&quot; 耗时：&quot;+lastTime+&quot; ms&quot;);
    }

    public void initBytes() throws TException {
        User user  = new User();
        user.setId(&quot;123&quot;);
        user.setAge(123);
        user.setDesc(&quot;ni hao i am test&quot;);
        user.setName(&quot;test&quot;);
        user.setTitle(&quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot;);
        user.setWeight(200);
        // 序列化
        ByteArrayOutputStream out = new ByteArrayOutputStream();
        TTransport trans = new TIOStreamTransport(out);
        TBinaryProtocol tp = new TBinaryProtocol(trans);
        user.write(tp);
        bytes = out.toByteArray();

    }

    public static void main(String [] args) throws TException {
        ThriftSimlpleTest test = new ThriftSimlpleTest();
        test.serialization();
        test.un_serialization();

    }

}

</code></pre>

<p>3、protobuf 固定1分钟此测试代码（简单对象）</p>

<pre><code class="language-java">package com.many.pro.thriftvsproto;

import com.google.protobuf.InvalidProtocolBufferException;
import com.many.pro.UserModel;

import java.util.concurrent.*;


public class PBSimpleOneMinutes {

    static int sum = 0;

    static  final ExecutorService exec = Executors.newFixedThreadPool(1);

    private static  byte  [] bytes ;

    static class Service implements Runnable{

        @Override
        public void run() {
            while (true){
                serialization();
                un_serialization();
                sum++;
            }
        }
    }

    public static void un_serialization(){
       // initBytes();
      //  long start = System.currentTimeMillis();
        try {
             UserModel.User.parseFrom(bytes);
        } catch (InvalidProtocolBufferException e) {
            e.printStackTrace();
        }

        //int size = bytes.length;
       // long lastTime = System.currentTimeMillis() - start;
       // System.out.println(&quot;protobuffer 反序列化循环100w times，单条大小：&quot;+size+&quot; byte&quot;+&quot; 耗时：&quot;+lastTime+&quot; ms&quot;);
    }

    public static void serialization(){
        UserModel.User.Builder builder = UserModel.User.newBuilder();
        builder.setId(&quot;123&quot;);
        builder.setAge(123);
        builder.setDesc(&quot;ni hao i am test&quot;);
        builder.setName(&quot;test&quot;);
        builder.setTitle(&quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot;);
        builder.setWeight(200);
        UserModel.User  user = builder.build();
        user.toByteArray();

    }


    public static void initBytes(){
        UserModel.User.Builder builder = UserModel.User.newBuilder();
        builder.setId(&quot;123&quot;);
        builder.setAge(123);
        builder.setDesc(&quot;ni hao i am test&quot;);
        builder.setName(&quot;test&quot;);
        builder.setTitle(&quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot;);
        builder.setWeight(200);
        UserModel.User  user = builder.build();
        bytes = user.toByteArray();

    }

    public static void main(String [] a){

        initBytes();
        Future future = exec.submit(new Service());
        try {
            future.get(60, TimeUnit.SECONDS);
        } catch (InterruptedException e) {
            e.printStackTrace();
        } catch (ExecutionException e) {
            e.printStackTrace();
        } catch (TimeoutException e) {
            e.printStackTrace();
        }

        System.out.println(&quot;60 seconds run &quot; + sum + &quot; tiems&quot;);
    }

}

</code></pre>

<p>4、thrift 固定1分钟此测试代码（简单对象）</p>

<pre><code class="language-java">package com.many.pro.thriftvsproto;



import org.apache.thrift.TException;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.util.concurrent.*;
import com.many.thrift.User;
import org.apache.thrift.protocol.TBinaryProtocol;
import org.apache.thrift.transport.TIOStreamTransport;
import org.apache.thrift.transport.TTransport;



public class ThriftSimpleOneMinutes {

    static int sum = 0;

    private static byte [] bytes;

    static  final ExecutorService exec = Executors.newFixedThreadPool(1);

    static class Service implements Runnable{
        @Override
        public void run() {
            while (true){
                try {
                    serialization();
                    un_serialization();
                } catch (TException e) {
                    e.printStackTrace();
                }
                sum++;
            }
        }
    }

    public static void serialization() throws TException {
        User user  = new User();
        user.setId(&quot;123&quot;);
        user.setAge(123);
        user.setDesc(&quot;ni hao i am test&quot;);
        user.setName(&quot;test&quot;);
        user.setTitle(&quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot;);
        user.setWeight(200);
        // 序列化
        ByteArrayOutputStream out = new ByteArrayOutputStream();
        TTransport trans = new TIOStreamTransport(out);
        TBinaryProtocol tp = new TBinaryProtocol(trans);
        user.write(tp);
    }

    public static void un_serialization() throws TException {

        ByteArrayInputStream in = new ByteArrayInputStream(bytes);
        TTransport trans = new TIOStreamTransport(in);
        TBinaryProtocol tp  = new TBinaryProtocol(trans);
        User user  = new User();
        user.read(tp);
    }

    public static void initBytes() throws TException {
        User user  = new User();
        user.setId(&quot;123&quot;);
        user.setAge(123);
        user.setDesc(&quot;ni hao i am test&quot;);
        user.setName(&quot;test&quot;);
        user.setTitle(&quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot; +
                &quot;this is a test vs thrift serialization this is a test vs thrift serialization this is a test vs thrift serialization&quot;);
        user.setWeight(200);
        // 序列化
        ByteArrayOutputStream out = new ByteArrayOutputStream();
        TTransport trans = new TIOStreamTransport(out);
        TBinaryProtocol tp = new TBinaryProtocol(trans);
        user.write(tp);
        bytes = out.toByteArray();

    }

    public static void main(String [] a){
        try {
            initBytes();
        } catch (TException e) {
            e.printStackTrace();
        }
        Future future = exec.submit(new Service());
        try {
            future.get(60, TimeUnit.SECONDS);
        } catch (InterruptedException e) {
            e.printStackTrace();
        } catch (ExecutionException e) {
            e.printStackTrace();
        } catch (TimeoutException e) {
            e.printStackTrace();
        }

        System.out.println(&quot;60 seconds run &quot; + sum + &quot; tiems&quot;);
    }

}

</code></pre>

<h2 id="复杂对象结构的对比">复杂对象结构的对比</h2>

<h3 id="protobuf-文件-1">protobuf 文件</h3>

<pre><code class="language-xml">// See README.txt for information and build instructions.

package tutorial;

option java_package = &quot;com.many.pro&quot;;
option java_outer_classname = &quot;PersonAddressBook&quot;;

message Person {
  required string name = 1;
  required int32 id = 2;
  optional string email = 3;

  enum PhoneType {
    MOBILE = 0;
    HOME = 1;
    WORK = 2;
  }

  message PhoneNumber {
    required string number = 1;
    optional PhoneType type = 2 [default = HOME];
  }

  repeated PhoneNumber phone = 4;
}

// Our address book file is just one of these.
message AddressBook {
  required string name = 1;
  repeated Person person = 2; // contacts
}

</code></pre>

<h3 id="thrift-文件-1">thrift 文件</h3>

<pre><code class="language-xml">namespace java com.many.thrift

// phone type
enum PhoneType {
  MOBILE =      0
  HOME =        1
  WORK =        2
 }

struct PhoneNumber {
    1: required string number;
    2: optional PhoneType type = PhoneType.MOBILE;
}

struct Person{
  1: required string name;
  2: required i32 id;
  3: optional string email;
  4: required list&lt;PhoneNumber&gt; phones;

}

struct AddressBook {
  1: required string name;
  2: required list&lt;Person&gt; persons;// contacts
}
</code></pre>

<h3 id="测试前提-1">测试前提：</h3>

<p>测试对象：测试时都会设置相同的属性值，保证测试公平</p>

<h3 id="测试结果-1">测试结果：</h3>

<p>1、固定1分钟测试结果</p>

<table>
<thead>
<tr>
<th>名称</th>
<th>动作</th>
<th>大小</th>
<th>次数</th>
</tr>
</thead>

<tbody>
<tr>
<td>protobuf</td>
<td>序列化</td>
<td>29934 byte</td>
<td>52345</td>
</tr>

<tr>
<td>thrift</td>
<td>序列化</td>
<td>44476 byte</td>
<td>43103</td>
</tr>

<tr>
<td>protobuf</td>
<td>反序列化</td>
<td>29934 byte</td>
<td>200191</td>
</tr>

<tr>
<td>thrift</td>
<td>反序列化</td>
<td>44476 byte</td>
<td>44181</td>
</tr>

<tr>
<td>protobuf</td>
<td>序列化反序列化交替进行</td>
<td>29934 byte</td>
<td>41788*2</td>
</tr>

<tr>
<td>thrift</td>
<td>序列化反序列化交替进行</td>
<td>44476 byte</td>
<td>23028*2</td>
</tr>
</tbody>
</table>

<p>2、固定次数（1000000次）测试结果：</p>

<table>
<thead>
<tr>
<th>名称</th>
<th>动作</th>
<th>大小</th>
<th>时间(ms)</th>
</tr>
</thead>

<tbody>
<tr>
<td>protobuf</td>
<td>序列化</td>
<td>29934 byte</td>
<td>12956</td>
</tr>

<tr>
<td>thrift</td>
<td>序列化</td>
<td>44476 byte</td>
<td>16951</td>
</tr>

<tr>
<td>protobuf</td>
<td>反序列化</td>
<td>29934 byte</td>
<td>3120</td>
</tr>

<tr>
<td>thrift</td>
<td>反序列化</td>
<td>44476 byte</td>
<td>14429</td>
</tr>
</tbody>
</table>

<h3 id="测试代码-1">测试代码</h3>

<p>1、protobuf 固定10000次测试代码（复杂对象）</p>

<pre><code class="language-java">package com.many.pro.thriftvsproto;

import com.google.protobuf.InvalidProtocolBufferException;
import com.many.pro.PersonAddressBook;


public class ProtoComplexTest {
    private byte [] bytes;
    public void serialization(){
        long start = System.currentTimeMillis();
        for(int i=0;i&lt;10000;i++){

            // book
            PersonAddressBook.AddressBook.Builder book_builder = PersonAddressBook.AddressBook.newBuilder();
            book_builder.setName(&quot;rec_system&quot;);

            //300个 person_builder
            for(int j=0;j&lt;300;j++){
                PersonAddressBook.Person.Builder person_builder = PersonAddressBook.Person.newBuilder();
                person_builder.setId(j);
                person_builder.setName(&quot;zhangbin_&quot; + j);
                person_builder.setEmail(&quot;zhaojun@gmail.com&quot; +j);

                PersonAddressBook.Person.PhoneNumber.Builder phoneNumber_builder =  PersonAddressBook.Person.PhoneNumber.newBuilder();
                phoneNumber_builder.setNumber(&quot;1298912313&quot;+j);
                phoneNumber_builder.setType(PersonAddressBook.Person.PhoneType.HOME);
                PersonAddressBook.Person.PhoneNumber.Builder phoneNumber_builder_1 =  PersonAddressBook.Person.PhoneNumber.newBuilder();
                phoneNumber_builder_1.setNumber(&quot;129891231we3&quot;+j);
                phoneNumber_builder_1.setType(PersonAddressBook.Person.PhoneType.MOBILE);
                PersonAddressBook.Person.PhoneNumber.Builder phoneNumber_builder_2 =  PersonAddressBook.Person.PhoneNumber.newBuilder();
                phoneNumber_builder_2.setNumber(&quot;129891231we3&quot;+j);
                phoneNumber_builder_2.setType(PersonAddressBook.Person.PhoneType.WORK);

                person_builder.addPhone(phoneNumber_builder);
                person_builder.addPhone(phoneNumber_builder_1);
                person_builder.addPhone(phoneNumber_builder_2);

                book_builder.addPerson(person_builder);
            }

            PersonAddressBook.AddressBook  book  = book_builder.build();
            book.toByteArray();
          //  System.out.println(i);
        }
        long lastTime = System.currentTimeMillis() - start;
        initBytes();
        int size = bytes.length;
        System.out.println(&quot;protobuffer 序列化循环1 w times，单条大小：&quot;+size+&quot; byte&quot;+&quot; 耗时：&quot;+lastTime+&quot; ms&quot;);
    }

    public void un_serialization(){
        initBytes();
        long start = System.currentTimeMillis();
        try {
            for(int i=0;i&lt;10000;i++){

                   PersonAddressBook.AddressBook.parseFrom(bytes);

            }
        } catch (InvalidProtocolBufferException e) {
            e.printStackTrace();
        }

        int size = bytes.length;
        long lastTime = System.currentTimeMillis() - start;
        System.out.println(&quot;protobuffer 反序列化循环1 w times，单条大小：&quot;+size+&quot; byte&quot;+&quot; 耗时：&quot;+lastTime+&quot; ms&quot;);
    }

    public void initBytes(){
        // book
        PersonAddressBook.AddressBook.Builder book_builder = PersonAddressBook.AddressBook.newBuilder();
        book_builder.setName(&quot;rec_system&quot;);

        //300个 person_builder
        for(int j=0;j&lt;300;j++){
            PersonAddressBook.Person.Builder person_builder = PersonAddressBook.Person.newBuilder();
            person_builder.setId(j);
            person_builder.setName(&quot;zhangbin_&quot; + j);
            person_builder.setEmail(&quot;zhaojun@gmail.com&quot; + j);

            PersonAddressBook.Person.PhoneNumber.Builder phoneNumber_builder =  PersonAddressBook.Person.PhoneNumber.newBuilder();
            phoneNumber_builder.setNumber(&quot;1298912313&quot;+j);
            phoneNumber_builder.setType(PersonAddressBook.Person.PhoneType.HOME);
            PersonAddressBook.Person.PhoneNumber.Builder phoneNumber_builder_1 =  PersonAddressBook.Person.PhoneNumber.newBuilder();
            phoneNumber_builder_1.setNumber(&quot;129891231we3&quot;+j);
            phoneNumber_builder_1.setType(PersonAddressBook.Person.PhoneType.MOBILE);
            PersonAddressBook.Person.PhoneNumber.Builder phoneNumber_builder_2 =  PersonAddressBook.Person.PhoneNumber.newBuilder();
            phoneNumber_builder_2.setNumber(&quot;129891231we3&quot;+j);
            phoneNumber_builder_2.setType(PersonAddressBook.Person.PhoneType.WORK);

            person_builder.addPhone(phoneNumber_builder);
            person_builder.addPhone(phoneNumber_builder_1);
            person_builder.addPhone(phoneNumber_builder_2);

            book_builder.addPerson(person_builder);
        }

        PersonAddressBook.AddressBook  book  = book_builder.build();
        bytes = book.toByteArray();

    }


    public static void main(String [] args){
        ProtoComplexTest test = new ProtoComplexTest();
        test.serialization();
        test.un_serialization();

    }
}

</code></pre>

<p>2、thrift 固定10000次测试代码（复杂对象）</p>

<pre><code class="language-java">package com.many.pro.thriftvsproto;



import com.many.thrift.*;
import com.many.thrift.AddressBook;
import com.many.thrift.Person;
import com.many.thrift.PhoneNumber;
import com.many.thrift.PhoneType;
import org.apache.thrift.TException;
import org.apache.thrift.protocol.TBinaryProtocol;
import org.apache.thrift.transport.TIOStreamTransport;
import org.apache.thrift.transport.TTransport;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;


public class ThriftComplexTest {

    private byte [] bytes;



    public void serialization() throws TException {
        long start = System.currentTimeMillis();
        for(int i=0;i&lt;10000;i++){
            AddressBook book = new AddressBook();
            book.setName(&quot;rec_system&quot;);
            // person 300
            for(int j=0;j&lt;300;j++){
                Person person = new Person();
                person.setEmail(&quot;zhaojun@gmail.com&quot;+j);
                person.setId(i);
                person.setName(&quot;zhangbin_&quot; + j);

                PhoneNumber n1 = new PhoneNumber();
                n1.setNumber(&quot;1298912313&quot;+j);
                n1.setType(PhoneType.HOME);
                PhoneNumber n2 = new PhoneNumber();
                n2.setNumber(&quot;129891231we3&quot;+j);
                n2.setType(PhoneType.MOBILE);
                PhoneNumber n3 = new PhoneNumber();
                n3.setNumber(&quot;129891231we3&quot; +j);
                n3.setType(PhoneType.WORK);
                person.addToPhones(n1);
                person.addToPhones(n2);
                person.addToPhones(n3);
                book.addToPersons(person);
            }

            ByteArrayOutputStream out = new ByteArrayOutputStream();
            TTransport trans = new TIOStreamTransport(out);
            TBinaryProtocol tp = new TBinaryProtocol(trans);
            book.write(tp);
        }
        long lastTime = System.currentTimeMillis() - start;
        initBytes();
        int size = bytes.length;
        System.out.println(&quot;Thrift 序列化循环1w times，单条大小：&quot;+size+&quot; byte&quot;+&quot; 耗时：&quot;+lastTime+&quot; ms&quot;);
    }



    public void un_serialization() throws TException {
        initBytes();
        long start = System.currentTimeMillis();
        for(int i=0;i&lt;10000;i++){
            ByteArrayInputStream in = new ByteArrayInputStream(bytes);
            TTransport trans = new TIOStreamTransport(in);
            TBinaryProtocol tp  = new TBinaryProtocol(trans);
            AddressBook book  = new AddressBook();
            book.read(tp);
        }

        int size = bytes.length;
        long lastTime = System.currentTimeMillis() - start;
        System.out.println(&quot;Thrift 反序列化循环1w times，单条大小：&quot;+size+&quot; byte&quot;+&quot; 耗时：&quot;+lastTime+&quot; ms&quot;);
    }

    public void initBytes() throws TException {

        AddressBook book = new AddressBook();
        book.setName(&quot;rec_system&quot;);
        // person 300
        for(int j=0;j&lt;300;j++){
            Person person = new Person();
            person.setEmail(&quot;zhaojun@gmail.com&quot;+j);
            person.setId(j);
            person.setName(&quot;zhangbin_&quot; + j);

            PhoneNumber n1 = new PhoneNumber();
            n1.setNumber(&quot;1298912313&quot;+j);
            n1.setType(PhoneType.HOME);
            PhoneNumber n2 = new PhoneNumber();
            n2.setNumber(&quot;129891231we3&quot;+j);
            n2.setType(PhoneType.MOBILE);
            PhoneNumber n3 = new PhoneNumber();
            n3.setNumber(&quot;129891231we3&quot; +j);
            n3.setType(PhoneType.WORK);
            person.addToPhones(n1);
            person.addToPhones(n2);
            person.addToPhones(n3);
            book.addToPersons(person);
        }

        ByteArrayOutputStream out = new ByteArrayOutputStream();
        TTransport trans = new TIOStreamTransport(out);
        TBinaryProtocol tp = new TBinaryProtocol(trans);
        book.write(tp);
        bytes = out.toByteArray();
    }


    public static void main(String [] args) throws TException {
        ThriftComplexTest test = new ThriftComplexTest();
        test.serialization();
        test.un_serialization();

    }

}


</code></pre>

<p>3、protobuf 固定1分钟测试代码（复杂对象）</p>

<pre><code class="language-java">package com.many.pro.thriftvsproto;

import com.google.protobuf.InvalidProtocolBufferException;
import com.many.pro.PersonAddressBook;
import com.many.pro.UserModel;

import java.util.concurrent.*;


public class PBComplexOneMinutes {

    static int sum = 0;

    static  final ExecutorService exec = Executors.newFixedThreadPool(1);

    private static  byte  [] bytes ;

    static class Service implements Runnable{

        @Override
        public void run() {
            while (true){
                serialization();
                un_serialization();
                sum++;
            }
        }
    }

    public static void un_serialization(){
        try {
            PersonAddressBook.AddressBook.parseFrom(bytes);
        } catch (InvalidProtocolBufferException e) {
            e.printStackTrace();
        }
    }

    public static void serialization(){
        // book
        PersonAddressBook.AddressBook.Builder book_builder = PersonAddressBook.AddressBook.newBuilder();
        book_builder.setName(&quot;rec_system&quot;);

        //300个 person_builder
        for(int j=0;j&lt;300;j++){
            PersonAddressBook.Person.Builder person_builder = PersonAddressBook.Person.newBuilder();
            person_builder.setId(j);
            person_builder.setName(&quot;zhangbin_&quot; + j);
            person_builder.setEmail(&quot;zhaojun@gmail.com&quot; +j);

            PersonAddressBook.Person.PhoneNumber.Builder phoneNumber_builder =  PersonAddressBook.Person.PhoneNumber.newBuilder();
            phoneNumber_builder.setNumber(&quot;1298912313&quot;+j);
            phoneNumber_builder.setType(PersonAddressBook.Person.PhoneType.HOME);
            PersonAddressBook.Person.PhoneNumber.Builder phoneNumber_builder_1 =  PersonAddressBook.Person.PhoneNumber.newBuilder();
            phoneNumber_builder_1.setNumber(&quot;129891231we3&quot;+j);
            phoneNumber_builder_1.setType(PersonAddressBook.Person.PhoneType.MOBILE);
            PersonAddressBook.Person.PhoneNumber.Builder phoneNumber_builder_2 =  PersonAddressBook.Person.PhoneNumber.newBuilder();
            phoneNumber_builder_2.setNumber(&quot;129891231we3&quot;+j);
            phoneNumber_builder_2.setType(PersonAddressBook.Person.PhoneType.WORK);

            person_builder.addPhone(phoneNumber_builder);
            person_builder.addPhone(phoneNumber_builder_1);
            person_builder.addPhone(phoneNumber_builder_2);

            book_builder.addPerson(person_builder);
        }

        PersonAddressBook.AddressBook  book  = book_builder.build();
        book.toByteArray();

    }


    public static void initBytes(){
        // book
        PersonAddressBook.AddressBook.Builder book_builder = PersonAddressBook.AddressBook.newBuilder();
        book_builder.setName(&quot;rec_system&quot;);

        //300个 person_builder
        for(int j=0;j&lt;300;j++){
            PersonAddressBook.Person.Builder person_builder = PersonAddressBook.Person.newBuilder();
            person_builder.setId(j);
            person_builder.setName(&quot;zhangbin_&quot; + j);
            person_builder.setEmail(&quot;zhaojun@gmail.com&quot; + j);

            PersonAddressBook.Person.PhoneNumber.Builder phoneNumber_builder =  PersonAddressBook.Person.PhoneNumber.newBuilder();
            phoneNumber_builder.setNumber(&quot;1298912313&quot;+j);
            phoneNumber_builder.setType(PersonAddressBook.Person.PhoneType.HOME);
            PersonAddressBook.Person.PhoneNumber.Builder phoneNumber_builder_1 =  PersonAddressBook.Person.PhoneNumber.newBuilder();
            phoneNumber_builder_1.setNumber(&quot;129891231we3&quot;+j);
            phoneNumber_builder_1.setType(PersonAddressBook.Person.PhoneType.MOBILE);
            PersonAddressBook.Person.PhoneNumber.Builder phoneNumber_builder_2 =  PersonAddressBook.Person.PhoneNumber.newBuilder();
            phoneNumber_builder_2.setNumber(&quot;129891231we3&quot;+j);
            phoneNumber_builder_2.setType(PersonAddressBook.Person.PhoneType.WORK);

            person_builder.addPhone(phoneNumber_builder);
            person_builder.addPhone(phoneNumber_builder_1);
            person_builder.addPhone(phoneNumber_builder_2);

            book_builder.addPerson(person_builder);
        }

        PersonAddressBook.AddressBook  book  = book_builder.build();
        bytes = book.toByteArray();

    }

    public static void main(String [] a){

        initBytes();
        Future future = exec.submit(new Service());
        try {
            future.get(60, TimeUnit.SECONDS);
        } catch (InterruptedException e) {
            e.printStackTrace();
        } catch (ExecutionException e) {
            e.printStackTrace();
        } catch (TimeoutException e) {
            e.printStackTrace();
        }

        System.out.println(&quot;60 seconds run &quot; + sum + &quot; tiems&quot;);
    }

}

</code></pre>

<p>4、thrift 固定1分钟测试代码（复杂对象）</p>

<pre><code class="language-java">package com.many.pro.thriftvsproto;


import com.many.thrift.AddressBook;
import com.many.thrift.Person;
import com.many.thrift.PhoneNumber;
import com.many.thrift.PhoneType;
import org.apache.thrift.TException;
import org.apache.thrift.protocol.TBinaryProtocol;
import org.apache.thrift.transport.TIOStreamTransport;
import org.apache.thrift.transport.TTransport;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.util.concurrent.*;



public class ThriftComplexOneMinutes {

    static int sum = 0;

    private static byte [] bytes;

    static  final ExecutorService exec = Executors.newFixedThreadPool(1);

    static class Service implements Runnable{

        @Override
        public void run() {
            while (true){
                try {
                    serialization();
                   /// un_serialization();
                } catch (TException e) {
                    e.printStackTrace();
                }
                sum++;
            }
        }
    }

    public static void serialization() throws TException {
        AddressBook book = new AddressBook();
        book.setName(&quot;rec_system&quot;);
        // person 300
        for(int j=0;j&lt;300;j++){
            Person person = new Person();
            person.setEmail(&quot;zhaojun@gmail.com&quot;+j);
            person.setId(j);
            person.setName(&quot;zhangbin_&quot; + j);

            PhoneNumber n1 = new PhoneNumber();
            n1.setNumber(&quot;1298912313&quot;+j);
            n1.setType(com.many.thrift.PhoneType.HOME);
            PhoneNumber n2 = new PhoneNumber();
            n2.setNumber(&quot;129891231we3&quot;+j);
            n2.setType(PhoneType.MOBILE);
            PhoneNumber n3 = new PhoneNumber();
            n3.setNumber(&quot;129891231we3&quot; +j);
            n3.setType(PhoneType.WORK);
            person.addToPhones(n1);
            person.addToPhones(n2);
            person.addToPhones(n3);
            book.addToPersons(person);
        }

        ByteArrayOutputStream out = new ByteArrayOutputStream();
        TTransport trans = new TIOStreamTransport(out);
        TBinaryProtocol tp = new TBinaryProtocol(trans);
        book.write(tp);
    }

    public static void un_serialization() throws TException {

        ByteArrayInputStream in = new ByteArrayInputStream(bytes);
        TTransport trans = new TIOStreamTransport(in);
        TBinaryProtocol tp  = new TBinaryProtocol(trans);
        AddressBook book  = new AddressBook();
        book.read(tp);
    }

    public static void initBytes() throws TException {
        AddressBook book = new AddressBook();
        book.setName(&quot;rec_system&quot;);
        // person 300
        for(int j=0;j&lt;300;j++){
            Person person = new Person();
            person.setEmail(&quot;zhaojun@gmail.com&quot;+j);
            person.setId(j);
            person.setName(&quot;zhangbin_&quot; + j);

            PhoneNumber n1 = new PhoneNumber();
            n1.setNumber(&quot;1298912313&quot;+j);
            n1.setType(PhoneType.HOME);
            PhoneNumber n2 = new PhoneNumber();
            n2.setNumber(&quot;129891231we3&quot;+j);
            n2.setType(PhoneType.MOBILE);
            PhoneNumber n3 = new PhoneNumber();
            n3.setNumber(&quot;129891231we3&quot; +j);
            n3.setType(PhoneType.WORK);
            person.addToPhones(n1);
            person.addToPhones(n2);
            person.addToPhones(n3);
            book.addToPersons(person);
        }

        ByteArrayOutputStream out = new ByteArrayOutputStream();
        TTransport trans = new TIOStreamTransport(out);
        TBinaryProtocol tp = new TBinaryProtocol(trans);
        book.write(tp);
        bytes = out.toByteArray();

    }

    public static void main(String [] a){
        try {
            initBytes();
        } catch (TException e) {
            e.printStackTrace();
        }
        Future future = exec.submit(new Service());
        try {
            future.get(60, TimeUnit.SECONDS);
        } catch (InterruptedException e) {
            e.printStackTrace();
        } catch (ExecutionException e) {
            e.printStackTrace();
        } catch (TimeoutException e) {
            e.printStackTrace();
        }

        System.out.println(&quot;60 seconds run &quot; + sum + &quot; tiems&quot;);
    }

}

</code></pre>

  </div>
  <footer>
    <div class="article-footer">
      
<div class="tags">
  <ul>
    
    <li>
      <a href="/tags/protobuf"><span></span>protobuf</a>
    </li>
    
    <li>
      <a href="/tags/thrift"><span></span>Thrift</a>
    </li>
    
  </ul>
</div>


      
      
<div id="share-buttons">
  <ul>
    
    
    
    
    
  </ul>
</div>


      
<div class="ds-thread" data-thread-key="" data-title="Protobuf vs Thrift 性能测试" data-url="http://babifarm.com/post/2016/08/protobuf-vs-thrift/"></div>



<script type="text/javascript">
    var duoshuoQuery = {short_name:"babi"};

    (function() {
     var ds = document.createElement('script');
     ds.type = 'text/javascript';ds.async = true;
     ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
     ds.charset = 'UTF-8';
     (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
     })();
    </script>

      
      
      <div id="pagenavigation-next-prev">
        
        <div id="pagenavigation-next">
          <span class="pagenav-label">Previous</span>
          <a href="http://babifarm.com/post/2016/08/thrift/">thrift 教程</a>
        </div>
        
        
        <div id="pagenavigation-prev">
          <span class="pagenav-label">Next</span>
          <a href="http://babifarm.com/post/2016/08/protobuf/">protobuf 教程</a>
        </div>
        
      </div>
      
    </div>
  </footer>
</div>
        </div>
        <div class="sidebar">
  
  
  <div class="sidebar-content">
    <div class="sidebar-header">
      <span>Author</span>
    </div>
    <div id="author">
      <span>fisherman</span>
      <div>
        
        
        <a href="https://github.com/githoo"><i class="fa fa-github-square fa-2x" aria-hidden="true"></i></a>
        
        
      </div>
    </div>
  </div>
  
  
  <div class="sidebar-content">
    <div class="sidebar-header">
      <span>Categories</span>
    </div>
    <div class="categories">
      <ul>
        
        <li>
          <a href="/categories/about"><span></span>about (1)</a>
        </li>
        
        <li>
          <a href="/categories/%E5%B7%A5%E5%85%B7"><span></span>工具 (2)</a>
        </li>
        
        <li>
          <a href="/categories/%E6%8A%80%E6%9C%AF"><span></span>技术 (13)</a>
        </li>
        
      </ul>
    </div>
  </div>
  
  <div class="sidebar-content">
    <div class="sidebar-header">
      <span>RSS</span>
    </div>
    <div id="rss">
      <a href="/index.xml" type="application/rss+xml" target="_blank">
        <i class="fa fa-rss-square fa-2x" aria-hidden="true"></i>
      </a>
    </div>
  </div>
</div>

      </div>
      <footer>
        <div id="site-footer-wrap">
          <div id="site-footer">
            <span>Powered by <a href="https://gohugo.io/">Hugo</a>.</span>
            <span>
              
              Copyright (c) 2017, <a href="http://babifarm.com/">babifarm.com</a>
              
            </span>
            <span>  
              visits 
<script type="text/javascript">
var sc_project=11072857; 
var sc_invisible=0; 
var sc_security="98129f58"; 
var scJsHost = (("https:" == document.location.protocol) ?
"https://secure." : "http://www.");
document.write("<sc"+"ript type='text/javascript' src='" +
scJsHost+
"statcounter.com/counter/counter.js'></"+"script>");
</script>
<noscript><div class="statcounter"><a title="website
statistics" href="http://statcounter.com/"
target="_blank"><img class="statcounter"
src="//c.statcounter.com/11072857/0/98129f58/0/"
alt="website statistics"></a></div></noscript>

            </span>
          </div>
        </div>
      </footer>
    </div>
  </body>
</html>

